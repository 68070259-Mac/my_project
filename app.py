# üìÑ app.py (V5.3 - Smart Analysis)

import os
import datetime
from datetime import timedelta
from flask import Flask, request, jsonify, render_template
from flask_sqlalchemy import SQLAlchemy

app = Flask(__name__)
basedir = os.path.abspath(os.path.dirname(__file__))

# --- Database Config (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///' + os.path.join(basedir, 'app.db')
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
db = SQLAlchemy(app)

# --- Models (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
class DailyLog(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    log_date = db.Column(db.String(20), nullable=False)
    mood = db.Column(db.String(100))
    symptoms = db.Column(db.String(300))
    flow = db.Column(db.String(100))
    color = db.Column(db.String(100))
    notes = db.Column(db.Text)

class CycleHistory(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    start_date = db.Column(db.String(100))
    ovulation_date = db.Column(db.String(100))
    next_date = db.Column(db.String(100))

# --- API ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Upsert - ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° V5.2) ---
@app.route('/api/save-log', methods=['POST'])
def save_log():
    data = request.json
    log_date = data.get('date')
    if not log_date:
        return jsonify({"status": "error", "message": "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"}), 400

    symptoms_text = ",".join(data.get('symptoms', []))
    log = DailyLog.query.filter_by(log_date=log_date).first()

    if log:
        log.mood = data.get('mood')
        log.symptoms = symptoms_text
        log.flow = data.get('flow')
        log.color = data.get('color')
        log.notes = data.get('notes')
        message = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"
    else:
        log = DailyLog(
            log_date=log_date,
            mood=data.get('mood'),
            symptoms=symptoms_text,
            flow=data.get('flow'),
            color=data.get('color'),
            notes=data.get('notes')
        )
        db.session.add(log)
        message = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"

    db.session.commit()
    calendar_events = get_events_data() 
    return jsonify({
        "status": "success", 
        "message": message,
        "new_events": calendar_events
    })

# --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á Event (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° V5.2) ---
def get_events_data():
    events = []
    logs = DailyLog.query.all()
    for log in logs:
        title = ""
        color = "#CCCCCC"
        textColor = "#333"
        if log.flow and log.flow != "None":
            title = f"ü©∏ {log.flow}"
            if log.flow == "‡∏°‡∏≤‡∏Å": color = "#E53E3E"
            elif log.flow == "‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á": color = "#FB6A90"
            else: color = "#FABAC6"
            if log.mood and log.mood != "None":
                title += f" ({log.mood})"
            textColor = "white" if color != "#FABAC6" else "#333"
        elif log.mood and log.mood != "None":
            title = f"{log.mood}"
            if log.mood in ['üòä ‡∏£‡πà‡∏≤‡πÄ‡∏£‡∏¥‡∏á', '‚ö° ‡∏Å‡∏£‡∏∞‡∏õ‡∏£‡∏µ‡πâ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡∏£‡πà‡∏≤']:
                color = "#48BB78"; textColor = "white"
            elif log.mood in ['üò¢ ‡πÄ‡∏®‡∏£‡πâ‡∏≤', 'üò£ ‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î']:
                color = "#4299E1"; textColor = "white"
            elif log.mood == 'üò¥ ‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏•‡∏µ‡∏¢':
                color = "#A0AEC0"; textColor = "white"
            else:
                color = "#ECC94B"
        elif log.symptoms or log.notes:
            title = "üìù (‡∏°‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)"
            color = "#B0D3F2"
        else:
            continue
        events.append({"title": title, "start": log.log_date, "color": color, "textColor": textColor})
    return events

@app.route('/api/get-events')
def get_events():
    return jsonify(get_events_data())


# --- ü©∫ API ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û V5.3 (‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏™‡∏°‡∏≠‡∏á) ---
@app.route('/api/analyze', methods=['GET'])
def analyze_day():
    date = request.args.get('date')
    if not date:
        return jsonify({"status": "error", "message": "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"})

    log = DailyLog.query.filter_by(log_date=date).first()
    if not log:
        return jsonify({"status": "error", "message": "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ"})

    # --- ‡∏ï‡∏£‡∏£‡∏Å‡∏∞ Health Score (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° V5.2) ---
    score = 0
    symptoms_list = log.symptoms.split(',') if log.symptoms else [] 
    
    mood_str = log.mood or "" 
    flow_str = log.flow or ""
    color_str = log.color or ""
    notes_str = log.notes or ""

    mood_points = { 'üòä ‡∏£‡πà‡∏≤‡πÄ‡∏£‡∏¥‡∏á': 30, '‚ö° ‡∏Å‡∏£‡∏∞‡∏õ‡∏£‡∏µ‡πâ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡∏£‡πà‡∏≤': 25, 'üò¢ ‡πÄ‡∏®‡∏£‡πâ‡∏≤': 10, 'üò¥ ‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏•‡∏µ‡∏¢': 10, 'üò£ ‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î': 5 }
    flow_points = { '‡∏ô‡πâ‡∏≠‡∏¢': 20, '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á': 15, '‡∏°‡∏≤‡∏Å': 10 }
    color_points = { '‡∏ä‡∏°‡∏û‡∏π': 20, '‡πÅ‡∏î‡∏á‡∏™‡∏î': 15, '‡∏™‡πâ‡∏°': 10, '‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•': 5, '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏õ‡∏ô‡πÄ‡∏ó‡∏≤': 0, '‡∏î‡∏≥‡∏Ñ‡∏•‡πâ‡∏≥': 0 }

    score += mood_points.get(mood_str, 15)
    score += flow_points.get(flow_str, 15)
    score += color_points.get(color_str, 10)
    
    symptom_score = 35 - (len(symptoms_list) * 5)
    if '‚ö° ‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á' in symptoms_list:
        symptom_score -= 5
    score += max(0, symptom_score) 
    score = max(0, min(100, score))

    # --- ‚≠êÔ∏è (‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î!) ‡∏ï‡∏£‡∏£‡∏Å‡∏∞ Mascot, Tips, Advice ‚≠êÔ∏è ---
    
    # 1. ‡∏ï‡∏£‡∏£‡∏Å‡∏∞ Mascot (‡πÑ‡∏î‡∏ô‡∏≤‡∏°‡∏¥‡∏Å‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô)
    mascot = 'üôÇ' # ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    if score >= 80:
        mascot = 'ü•∞' # ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏î‡∏µ‡∏°‡∏≤‡∏Å
    elif score >= 50:
        mascot = 'üôÇ' # ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    else: # (score < 50)
        if '‚ö° ‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á' in symptoms_list:
            mascot = 'üòñ' # ‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á
        elif 'üò¥ ‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏•‡∏µ‡∏¢' in mood_str or 'üí§ ‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢' in symptoms_list:
            mascot = 'üòµ' # ‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢/‡πÄ‡∏û‡∏•‡∏µ‡∏¢
        elif 'üò¢ ‡πÄ‡∏®‡∏£‡πâ‡∏≤' in mood_str or 'üò£ ‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î' in mood_str:
            mascot = 'üòü' # ‡∏Å‡∏±‡∏á‡∏ß‡∏•
        else:
            mascot = 'üò¥' # ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏î‡∏µ

    # 2. ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö‡∏î‡∏π‡πÅ‡∏•‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á (Tips) (‡πÄ‡∏û‡∏¥‡πà‡∏° Tips)
    tips = []
    
    # -- Tips ‡∏à‡∏≤‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ (Symptoms) --
    if '‚ö° ‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á' in symptoms_list:
        tips.append("‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á‡πÄ‡∏´‡∏£‡∏≠? ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ñ‡∏∏‡∏á‡∏ô‡πâ‡∏≥‡∏£‡πâ‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏Ñ‡∏ö‡∏ó‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥‡∏Ç‡∏¥‡∏á‡∏≠‡∏∏‡πà‡∏ô‡πÜ ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞ üçµ")
    if 'üí§ ‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢' in symptoms_list:
        tips.append("‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢... ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏ô‡∏≠‡∏ô‡∏î‡∏∂‡∏Å ‡πÅ‡∏•‡∏∞‡∏´‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏á‡∏µ‡∏ö‡∏´‡∏•‡∏±‡∏ö‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏±‡∏ô‡∏™‡∏±‡∏Å 15-20 ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ô‡∏∞‡∏Ñ‡∏∞ üí§")
    if 'üò¥ ‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏•‡∏µ‡∏¢' in mood_str:
        tips.append("‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏•‡∏µ‡∏¢... ‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô ‡∏•‡∏≠‡∏á‡∏ó‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ò‡∏≤‡∏ï‡∏∏‡πÄ‡∏´‡∏•‡πá‡∏Å‡∏™‡∏π‡∏á ‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏±‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏±‡∏Å‡πÉ‡∏ö‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ô‡∏∞‡∏Ñ‡∏∞ ü•¨")
    if '‚òï ‡∏õ‡∏ß‡∏î‡∏´‡∏±‡∏ß' in symptoms_list:
        tips.append("‡∏õ‡∏ß‡∏î‡∏´‡∏±‡∏ß‡πÄ‡∏´‡∏£‡∏≠? ‡∏•‡∏≠‡∏á‡∏ô‡∏ß‡∏î‡πÄ‡∏ö‡∏≤‡πÜ ‡∏ó‡∏µ‡πà‡∏Ç‡∏°‡∏±‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏±‡∏Å‡∏™‡∏≤‡∏¢‡∏ï‡∏≤‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡∏ô‡∏∞‡∏Ñ‡∏∞ üñ•Ô∏è")
    if 'üíß ‡∏ó‡πâ‡∏≠‡∏á‡∏≠‡∏∑‡∏î' in symptoms_list:
        tips.append("‡∏ó‡πâ‡∏≠‡∏á‡∏≠‡∏∑‡∏î‡∏à‡∏±‡∏á... ‡∏•‡∏≠‡∏á‡∏ó‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏¥‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏¢‡πÄ‡∏Å‡∏¥‡∏£‡πå‡∏ï ‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏î‡∏•‡∏°‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞ ü•£")
    if 'üß° ‡πÄ‡∏à‡πá‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å' in symptoms_list:
        tips.append("‡πÄ‡∏à‡πá‡∏ö‡∏Ñ‡∏±‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏ï‡∏¥‡∏Å‡πà‡∏≠‡∏ô‡∏°‡∏µ‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‡∏•‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏ö‡∏£‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏ö‡∏≤‡∏¢‡∏ï‡∏±‡∏ß ‡πÑ‡∏°‡πà‡∏£‡∏±‡∏î‡πÅ‡∏ô‡πà‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏ô‡∏∞‡∏Ñ‡∏∞ üëö")

    # -- Tips ‡∏à‡∏≤‡∏Å‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå (Mood) --
    if 'üò¢ ‡πÄ‡∏®‡∏£‡πâ‡∏≤' in mood_str or 'üò£ ‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î' in mood_str:
        tips.append("‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÑ‡∏°‡πà‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏£‡∏≠? ‡∏•‡∏≠‡∏á‡∏ü‡∏±‡∏á‡πÄ‡∏û‡∏•‡∏á‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢, ‡∏ó‡∏≥‡∏™‡∏°‡∏≤‡∏ò‡∏¥‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≤‡∏ô‡∏î‡∏≤‡∏£‡πå‡∏Å‡∏ä‡πá‡∏≠‡∏Å‡πÇ‡∏Å‡πÅ‡∏•‡∏ï‡∏™‡∏±‡∏Å‡∏ä‡∏¥‡πâ‡∏ô ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏î‡πâ‡∏ô‡∏∞ üç´")

    # -- Tips ‡∏à‡∏≤‡∏Å‡∏™‡∏µ (Color) --
    if color_str == '‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•':
        tips.append("‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏Ç‡πâ‡∏°/‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏• ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡πÜ ‡∏Ç‡∏≠‡∏á‡∏£‡∏≠‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ñ‡πà‡∏∞ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏á‡∏ß‡∏• ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÑ‡∏´‡∏•‡∏≠‡∏≠‡∏Å‡∏°‡∏≤")
    if color_str == '‡∏ä‡∏°‡∏û‡∏π':
        tips.append("‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π‡∏à‡∏≤‡∏á‡πÜ ‡∏≠‡∏≤‡∏à‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ú‡∏™‡∏°‡∏Å‡∏±‡∏ö‡∏ï‡∏Å‡∏Ç‡∏≤‡∏ß ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡πÅ‡∏£‡∏Å‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡πÜ ‡∏Ñ‡πà‡∏∞")

    # -- Tip ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Default) --
    if not tips:
        tips.append("‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°! ‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏á‡∏ó‡∏µ‡πà ‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥‡∏≠‡∏∏‡πà‡∏ô‡πÜ ‡∏ï‡∏•‡∏≠‡∏î‡∏ß‡∏±‡∏ô ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÑ‡∏´‡∏•‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏ö‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞ üíß")
    
    self_care_tip = "<br><br>".join(tips)
    
    # 3. ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå (Doctor Advice) (‡∏â‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô)
    advice_list = []
    notes_lower = notes_str.lower()
    
    # -- Advice ‡∏à‡∏≤‡∏Å‡∏™‡∏µ (Color) --
    if color_str == '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏õ‡∏ô‡πÄ‡∏ó‡∏≤' or color_str == '‡∏î‡∏≥‡∏Ñ‡∏•‡πâ‡∏≥':
        advice_list.append(f"‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ({color_str}) ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡∏•‡∏≠‡∏î")
    if color_str == '‡∏™‡πâ‡∏°':
        advice_list.append("‡∏™‡∏µ‡∏™‡πâ‡∏°‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ú‡∏™‡∏°‡∏Å‡∏±‡∏ö‡∏ï‡∏Å‡∏Ç‡∏≤‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏•‡∏¥‡πà‡∏ô‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏£‡πà‡∏ß‡∏°‡∏î‡πâ‡∏ß‡∏¢ ‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏ä‡∏¥‡∏î‡∏ô‡∏∞‡∏Ñ‡∏∞")

    # -- Advice ‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Notes) ‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏ß‡∏° --
    if '‡∏Å‡πâ‡∏≠‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î' in notes_lower or '‡∏•‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏î' in notes_lower:
        if flow_str == '‡∏°‡∏≤‡∏Å':
            advice_list.append("‡∏Ñ‡∏∏‡∏ì‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡∏°‡∏µ '‡∏Å‡πâ‡∏≠‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î/‡∏•‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏î' ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô '‡∏°‡∏≤‡∏Å' ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ä‡πà‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏Ñ‡πà‡∏∞")
        else:
            advice_list.append("‡∏Ñ‡∏∏‡∏ì‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á '‡∏Å‡πâ‡∏≠‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏î/‡∏•‡∏¥‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏î' ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà (‡πÄ‡∏Å‡∏¥‡∏ô 1 ‡∏ô‡∏¥‡πâ‡∏ß) ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏°‡∏≤‡∏Å ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå")
            
    if '‡∏Å‡∏•‡∏¥‡πà‡∏ô‡πÄ‡∏´‡∏°‡πá‡∏ô' in notes_lower or '‡∏Å‡∏•‡∏¥‡πà‡∏ô‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥' in notes_lower:
        advice_list.append("‡∏Ñ‡∏∏‡∏ì‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á '‡∏Å‡∏•‡∏¥‡πà‡∏ô‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥' ‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠")
    
    if '‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á' in notes_lower or '‡∏õ‡∏ß‡∏î‡∏à‡∏ô‡∏ó‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏ß' in notes_lower:
         advice_list.append("‡∏Ñ‡∏∏‡∏ì‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤ '‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á' ‡∏´‡∏≤‡∏Å‡∏õ‡∏ß‡∏î‡∏°‡∏≤‡∏Å‡∏à‡∏ô‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡πÄ‡∏≠‡∏≤‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà ‡∏Ñ‡∏ß‡∏£‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏≤‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ô‡∏∞‡∏Ñ‡∏∞")

    # -- Advice ‡∏à‡∏≤‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ (Symptoms) --
    # (‡πÄ‡∏£‡∏≤‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á '' ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å split)
    valid_symptoms = [s for s in symptoms_list if s] 
    if len(valid_symptoms) >= 4:
        advice_list.append("‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô (4+ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£) ‡∏´‡∏≤‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥ ‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ô‡∏∞‡∏Ñ‡∏∞")
    
    # --- ‚≠êÔ∏è ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î ‚≠êÔ∏è ---

    # --- ‡∏™‡πà‡∏á JSON ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
    return jsonify({
        "status": "success",
        "date": log.log_date,
        "mood": mood_str,
        "symptoms": valid_symptoms, # ‚≠êÔ∏è ‡∏™‡πà‡∏á list ‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß
        "flow": flow_str,
        "color": color_str,
        "notes": notes_str,
        
        "health_score": score,
        "mascot": mascot,
        "self_care_tip": self_care_tip,
        "doctor_advice": advice_list
    })

# --- Route ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
@app.route('/')
def dashboard():
    return render_template('dashboard.html')

@app.route('/show_result')
def show_result_page():
    return render_template('result_page.html')

if __name__ == '__main__':
    app.run(debug=True, port=5000)